/*
 * main.c - ILI9486 demo for STM32F4.
 *
 * Copyright (C) 2016 Jan Havran
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */

#include "stm32f4xx.h"

/*
 * FIXME: HW SPI is badly implemented
 * fix it and remove software implementation
 */
#define CUSTOM_SPI

#define SCLK_GPIO	GPIO_Pin_5
#define MOSI_GPIO	GPIO_Pin_7
#define CE0_GPIO	GPIO_Pin_9
#define RS_GPIO		GPIO_Pin_10
#define DC_GPIO		GPIO_Pin_8

#ifndef CUSTOM_SPI
	#define SCLK_SOURCE	GPIO_PinSource5
	#define MOSI_SOURCE	GPIO_PinSource7
#endif	// CUSTOM_SPI

#define MIN(a,b)	(((a) < (b)) ? (a) : (b))

const int ili9486_init[] = {
	// Interface Mode Control
	-1, 0xb0, 0x0,
	// Sleep OUT
	-1, 0x11,
	-2, 250,
	// Interface Pixel Format, 16 bits / pixel
	-1, 0x3A, 0x55,
	// Memory Access Control
	-1, 0x36, 0x28,
	// Power Control 3 (For Normal Mode)
	-1, 0xC2, 0x44,
	// VCOM Control
	-1, 0xC5, 0x00, 0x00, 0x00, 0x00,
	// PGAMCTRL(Positive Gamma Control)
	-1, 0xE0, 0x0F, 0x1F, 0x1C, 0x0C, 0x0F, 0x08, 0x48, 0x98, 0x37, 0x0A,
		0x13, 0x04, 0x11, 0x0D, 0x00,
	// NGAMCTRL (Negative Gamma Correction)
	-1, 0xE1, 0x0F, 0x32, 0x2E, 0x0B, 0x0D, 0x05, 0x47, 0x75, 0x37, 0x06,
		0x10, 0x03, 0x24, 0x20, 0x00,
	// Digital Gamma Control 1
	-1, 0xE2, 0x0F, 0x32, 0x2E, 0x0B, 0x0D, 0x05, 0x47, 0x75, 0x37, 0x06,
		0x10, 0x03, 0x24, 0x20, 0x00,
	// Memory Access Control, BGR
	-1, 0x36, 0x28,
	// # Sleep OUT
	-1, 0x11,
	// Display ON
	-1, 0x29,
	-2, 250,
	-3};

const int small_font_width = 8;
const int small_font_height = 12;
const int small_font_start = 0x20;
const int small_font_size = 94;
const unsigned char small_font[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // <Space>
0x00,0x00,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x20,0x00,0x00, // !
0x00,0x28,0x50,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // "
0x00,0x00,0x28,0x28,0xFC,0x28,0x50,0xFC,0x50,0x50,0x00,0x00, // #
0x00,0x20,0x78,0xA8,0xA0,0x60,0x30,0x28,0xA8,0xF0,0x20,0x00, // $
0x00,0x00,0x48,0xA8,0xB0,0x50,0x28,0x34,0x54,0x48,0x00,0x00, // %
0x00,0x00,0x20,0x50,0x50,0x78,0xA8,0xA8,0x90,0x6C,0x00,0x00, // &
0x00,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // '
0x00,0x04,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x08,0x04,0x00, // (
0x00,0x40,0x20,0x10,0x10,0x10,0x10,0x10,0x10,0x20,0x40,0x00, // )
0x00,0x00,0x00,0x20,0xA8,0x70,0x70,0xA8,0x20,0x00,0x00,0x00, // *
0x00,0x00,0x20,0x20,0x20,0xF8,0x20,0x20,0x20,0x00,0x00,0x00, // +
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x40,0x80, // ,
0x00,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00, // -
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00, // .
0x00,0x08,0x10,0x10,0x10,0x20,0x20,0x40,0x40,0x40,0x80,0x00, // /
0x00,0x00,0x70,0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00,0x00, // 0
0x00,0x00,0x20,0x60,0x20,0x20,0x20,0x20,0x20,0x70,0x00,0x00, // 1
0x00,0x00,0x70,0x88,0x88,0x10,0x20,0x40,0x80,0xF8,0x00,0x00, // 2
0x00,0x00,0x70,0x88,0x08,0x30,0x08,0x08,0x88,0x70,0x00,0x00, // 3
0x00,0x00,0x10,0x30,0x50,0x50,0x90,0x78,0x10,0x18,0x00,0x00, // 4
0x00,0x00,0xF8,0x80,0x80,0xF0,0x08,0x08,0x88,0x70,0x00,0x00, // 5
0x00,0x00,0x70,0x90,0x80,0xF0,0x88,0x88,0x88,0x70,0x00,0x00, // 6
0x00,0x00,0xF8,0x90,0x10,0x20,0x20,0x20,0x20,0x20,0x00,0x00, // 7
0x00,0x00,0x70,0x88,0x88,0x70,0x88,0x88,0x88,0x70,0x00,0x00, // 8
0x00,0x00,0x70,0x88,0x88,0x88,0x78,0x08,0x48,0x70,0x00,0x00, // 9
0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x20,0x00,0x00, // :
0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x20,0x20,0x00, // ;
0x00,0x04,0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x04,0x00,0x00, // <
0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0xF8,0x00,0x00,0x00,0x00, // =
0x00,0x40,0x20,0x10,0x08,0x04,0x08,0x10,0x20,0x40,0x00,0x00, // >
0x00,0x00,0x70,0x88,0x88,0x10,0x20,0x20,0x00,0x20,0x00,0x00, // ?
0x00,0x00,0x70,0x88,0x98,0xA8,0xA8,0xB8,0x80,0x78,0x00,0x00, // @
0x00,0x00,0x20,0x20,0x30,0x50,0x50,0x78,0x48,0xCC,0x00,0x00, // A
0x00,0x00,0xF0,0x48,0x48,0x70,0x48,0x48,0x48,0xF0,0x00,0x00, // B
0x00,0x00,0x78,0x88,0x80,0x80,0x80,0x80,0x88,0x70,0x00,0x00, // C
0x00,0x00,0xF0,0x48,0x48,0x48,0x48,0x48,0x48,0xF0,0x00,0x00, // D
0x00,0x00,0xF8,0x48,0x50,0x70,0x50,0x40,0x48,0xF8,0x00,0x00, // E
0x00,0x00,0xF8,0x48,0x50,0x70,0x50,0x40,0x40,0xE0,0x00,0x00, // F
0x00,0x00,0x38,0x48,0x80,0x80,0x9C,0x88,0x48,0x30,0x00,0x00, // G
0x00,0x00,0xCC,0x48,0x48,0x78,0x48,0x48,0x48,0xCC,0x00,0x00, // H
0x00,0x00,0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0xF8,0x00,0x00, // I
0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x90,0xE0,0x00, // J
0x00,0x00,0xEC,0x48,0x50,0x60,0x50,0x50,0x48,0xEC,0x00,0x00, // K
0x00,0x00,0xE0,0x40,0x40,0x40,0x40,0x40,0x44,0xFC,0x00,0x00, // L
0x00,0x00,0xD8,0xD8,0xD8,0xD8,0xA8,0xA8,0xA8,0xA8,0x00,0x00, // M
0x00,0x00,0xDC,0x48,0x68,0x68,0x58,0x58,0x48,0xE8,0x00,0x00, // N
0x00,0x00,0x70,0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00,0x00, // O
0x00,0x00,0xF0,0x48,0x48,0x70,0x40,0x40,0x40,0xE0,0x00,0x00, // P
0x00,0x00,0x70,0x88,0x88,0x88,0x88,0xE8,0x98,0x70,0x18,0x00, // Q
0x00,0x00,0xF0,0x48,0x48,0x70,0x50,0x48,0x48,0xEC,0x00,0x00, // R
0x00,0x00,0x78,0x88,0x80,0x60,0x10,0x08,0x88,0xF0,0x00,0x00, // S
0x00,0x00,0xF8,0xA8,0x20,0x20,0x20,0x20,0x20,0x70,0x00,0x00, // T
0x00,0x00,0xCC,0x48,0x48,0x48,0x48,0x48,0x48,0x30,0x00,0x00, // U
0x00,0x00,0xCC,0x48,0x48,0x50,0x50,0x30,0x20,0x20,0x00,0x00, // V
0x00,0x00,0xA8,0xA8,0xA8,0x70,0x50,0x50,0x50,0x50,0x00,0x00, // W
0x00,0x00,0xD8,0x50,0x50,0x20,0x20,0x50,0x50,0xD8,0x00,0x00, // X
0x00,0x00,0xD8,0x50,0x50,0x20,0x20,0x20,0x20,0x70,0x00,0x00, // Y
0x00,0x00,0xF8,0x90,0x10,0x20,0x20,0x40,0x48,0xF8,0x00,0x00, // Z
0x00,0x38,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x38,0x00, // [
0x00,0x40,0x40,0x40,0x20,0x20,0x10,0x10,0x10,0x08,0x00,0x00, // <Backslash>
0x00,0x70,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x70,0x00, // ]
0x00,0x20,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ^
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC, // _
0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // '
0x00,0x00,0x00,0x00,0x00,0x30,0x48,0x38,0x48,0x3C,0x00,0x00, // a
0x00,0x00,0xC0,0x40,0x40,0x70,0x48,0x48,0x48,0x70,0x00,0x00, // b
0x00,0x00,0x00,0x00,0x00,0x38,0x48,0x40,0x40,0x38,0x00,0x00, // c
0x00,0x00,0x18,0x08,0x08,0x38,0x48,0x48,0x48,0x3C,0x00,0x00, // d
0x00,0x00,0x00,0x00,0x00,0x30,0x48,0x78,0x40,0x38,0x00,0x00, // e
0x00,0x00,0x1C,0x20,0x20,0x78,0x20,0x20,0x20,0x78,0x00,0x00, // f
0x00,0x00,0x00,0x00,0x00,0x3C,0x48,0x30,0x40,0x78,0x44,0x38, // g
0x00,0x00,0xC0,0x40,0x40,0x70,0x48,0x48,0x48,0xEC,0x00,0x00, // h
0x00,0x00,0x20,0x00,0x00,0x60,0x20,0x20,0x20,0x70,0x00,0x00, // i
0x00,0x00,0x10,0x00,0x00,0x30,0x10,0x10,0x10,0x10,0x10,0xE0, // j
0x00,0x00,0xC0,0x40,0x40,0x5C,0x50,0x70,0x48,0xEC,0x00,0x00, // k
0x00,0x00,0xE0,0x20,0x20,0x20,0x20,0x20,0x20,0xF8,0x00,0x00, // l
0x00,0x00,0x00,0x00,0x00,0xF0,0xA8,0xA8,0xA8,0xA8,0x00,0x00, // m
0x00,0x00,0x00,0x00,0x00,0xF0,0x48,0x48,0x48,0xEC,0x00,0x00, // n
0x00,0x00,0x00,0x00,0x00,0x30,0x48,0x48,0x48,0x30,0x00,0x00, // o
0x00,0x00,0x00,0x00,0x00,0xF0,0x48,0x48,0x48,0x70,0x40,0xE0, // p
0x00,0x00,0x00,0x00,0x00,0x38,0x48,0x48,0x48,0x38,0x08,0x1C, // q
0x00,0x00,0x00,0x00,0x00,0xD8,0x60,0x40,0x40,0xE0,0x00,0x00, // r
0x00,0x00,0x00,0x00,0x00,0x78,0x40,0x30,0x08,0x78,0x00,0x00, // s
0x00,0x00,0x00,0x20,0x20,0x70,0x20,0x20,0x20,0x18,0x00,0x00, // t
0x00,0x00,0x00,0x00,0x00,0xD8,0x48,0x48,0x48,0x3C,0x00,0x00, // u
0x00,0x00,0x00,0x00,0x00,0xEC,0x48,0x50,0x30,0x20,0x00,0x00, // v
0x00,0x00,0x00,0x00,0x00,0xA8,0xA8,0x70,0x50,0x50,0x00,0x00, // w
0x00,0x00,0x00,0x00,0x00,0xD8,0x50,0x20,0x50,0xD8,0x00,0x00, // x
0x00,0x00,0x00,0x00,0x00,0xEC,0x48,0x50,0x30,0x20,0x20,0xC0, // y
0x00,0x00,0x00,0x00,0x00,0x78,0x10,0x20,0x20,0x78,0x00,0x00, // z
0x00,0x18,0x10,0x10,0x10,0x20,0x10,0x10,0x10,0x10,0x18,0x00, // {
0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10, // |
0x00,0x60,0x20,0x20,0x20,0x10,0x20,0x20,0x20,0x20,0x60,0x00, // }
0x40,0xA4,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ~
}; 

void ms_delay(unsigned ms)
{
	unsigned x;
	while (ms > 0) {
		x=5971;
		while (x > 0) {
			__asm("nop");
			x--;
		}
		ms--;
	}
}

#ifdef CUSTOM_SPI
void CustomSPI_SendData(uint16_t data)
{
	int i;

	for (i = 0; i < 16; i++) {
		if ((data << i) & 0x8000)
			GPIO_SetBits(GPIOA, MOSI_GPIO);
		else
			GPIO_ResetBits(GPIOA, MOSI_GPIO);

		GPIO_SetBits(GPIOA, SCLK_GPIO);
		GPIO_ResetBits(GPIOA, SCLK_GPIO);
	}
}
#endif	// CUSTOM_SPI

void XSPI_SendData(uint16_t data)
{
	GPIO_ResetBits(GPIOA, CE0_GPIO);

#ifndef CUSTOM_SPI
	SPI_SendData(SPI1, data);
	while (SPI_GetFlagStatus(SPI1, SPI_I2S_FLAG_BSY)) ;
	while (SPI_GetFlagStatus(SPI1, SPI_I2S_FLAG_TXE)) ;
#else
	CustomSPI_SendData(data);
#endif	// CUSTOM_SPI

	GPIO_SetBits(GPIOA, CE0_GPIO);
}

void SendCmd(uint16_t cmd)
{
	GPIO_ResetBits(GPIOA, DC_GPIO);
	XSPI_SendData(cmd);
}

void SendParams(uint16_t params)
{
	GPIO_SetBits(GPIOA, DC_GPIO);
	XSPI_SendData(params);
}

void init_stm32(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
#ifndef CUSTOM_SPI
	SPI_InitTypeDef  SPI_InitStructure;
#endif	// CUSTOM_SPI

	/* Enable peripheral clock for SPI1 */
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_SPI1, ENABLE);

	/* Enable peripheral clock for GPIO A */
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE);

	/* Common GPIO config */
	GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
	GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_UP;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_25MHz;

	/* Output GPIO config */
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;	// output
#ifndef CUSTOM_SPI
	GPIO_InitStructure.GPIO_Pin = RS_GPIO | DC_GPIO | CE0_GPIO;
#else
	GPIO_InitStructure.GPIO_Pin = RS_GPIO | DC_GPIO | CE0_GPIO | SCLK_GPIO |
		MOSI_GPIO;
#endif	// CUSTOM_SPI
	GPIO_Init(GPIOA, &GPIO_InitStructure);

#ifdef CUSTOM_SPI
	GPIO_ResetBits(GPIOA, MOSI_GPIO);
	GPIO_ResetBits(GPIOA, SCLK_GPIO);
#endif	// CUSTOM_SPI
	GPIO_SetBits(GPIOA, CE0_GPIO);

#ifndef CUSTOM_SPI
	/* SPI GPIO config */
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
	GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
	GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_UP;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;

	/* Init SCLK*/
	GPIO_InitStructure.GPIO_Pin = SCLK_GPIO;
	GPIO_Init(GPIOA, &GPIO_InitStructure);
	GPIO_PinAFConfig(GPIOA, SCLK_SOURCE, GPIO_AF_SPI1);

	/* Init MOSI */
	GPIO_InitStructure.GPIO_Pin =  MOSI_GPIO;
	GPIO_Init(GPIOA, &GPIO_InitStructure);
	GPIO_PinAFConfig(GPIOA, MOSI_SOURCE, GPIO_AF_SPI1);

	/* Init SPI */
	SPI_DeInit(SPI1);
	SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;
	SPI_InitStructure.SPI_Mode = SPI_Mode_Master;
	SPI_InitStructure.SPI_DataSize = SPI_DataSize_16b;
	SPI_InitStructure.SPI_CPOL = SPI_CPOL_Low;	//clock is low when idle
	SPI_InitStructure.SPI_CPHA = SPI_CPHA_1Edge;
	SPI_InitStructure.SPI_NSS = SPI_NSS_Hard;
	SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_256;
	SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;
	SPI_Init(SPI1, &SPI_InitStructure);
  
	/* Enable SPI */
	SPI_Cmd(SPI1, ENABLE);
#endif	// CUSTOM_SPI
}

void init_ili9486(const int code[])
{
	int done = 0;
	int const *cmd = ili9486_init;
	int is_cmd = 0;

	/* Reset LCD */
	GPIO_SetBits(GPIOA, RS_GPIO);
	GPIO_ResetBits(GPIOA, RS_GPIO);
	GPIO_SetBits(GPIOA, RS_GPIO);

	/* Write init code */
	while (!done) {
		switch (*cmd) {
		case -1:
			is_cmd = 1;
			break;
		case -2:
			cmd++;
			ms_delay(*cmd);
			break;
		case -3:
			done = 1;
			break;
		default:
			if (is_cmd) {
				SendCmd((uint16_t) *cmd);
				is_cmd = 0;
			}
			else
				SendParams((uint16_t) *cmd);

			break;
		}
		cmd++;
	}
}

int font_is_set(unsigned char c, int x, int y)
{
	char byte;
	int val = (int) c - small_font_start;

	if (val < 0 || val >= small_font_size)
		return 0;
	if (x > small_font_width || y > small_font_height)
		return 0;

	byte = small_font[val * small_font_height + y];

	return (byte << x) & 0x80;
}

uint16_t set_color(uint8_t r, uint8_t g, uint8_t b)
{
	uint16_t color;

	color  = MIN((uint16_t) r, 0x1F) << 11;
	color |= MIN((uint16_t) g, 0x3F) << 5;
	color |= MIN((uint16_t) b, 0x1F);

	return color;
}

void draw_pixel(int x, int y, uint16_t color)
{
	/* Set X coord */
	SendCmd(0x2A);
	SendParams(x >> 8);
	SendParams(x);
	SendParams(x >> 8);
	SendParams(x);

	/* Set Y coord */
	SendCmd(0x2B);
	SendParams(y >> 8);
	SendParams(y);
	SendParams(y >> 8);
	SendParams(y);

	/* Write data */
	SendCmd(0x2C);
	SendParams(color);
}

void lcd_char(char c, int x, int y, uint16_t color)
{
	int i, j;

	for (i = 0; i < small_font_height; i++) {
		for (j = 0; j < small_font_width; j++) {
			if (font_is_set(c, j, i))
				draw_pixel(x, y, color);
			x += 1;
		}
		x -= 8;
		y += 1;
	}
}

void lcd_printf(const char *str, int x, int y, uint16_t color)
{
	const char *c = str;
	int x_s = x;

	while (*c != '\0') {
		if (*c == '\n') {
			y += 13;
			x = x_s;
		}
		else {
			lcd_char(*c, x, y, color);
			x += 9;
		}
		c++;
	}
}

int main(void)
{
	int i;
	uint16_t color;

	init_stm32();
	init_ili9486(ili9486_init);

	color = set_color(28, 45, 10);
	lcd_printf("ILI9486 driver\n"
		"STM32F4 - NUCLEO-F446RE\n"
		"Bare metal",
		30, 80, color);

	for (i = 0; i < 64; i++) {
		color = set_color(i, i, i);
		draw_pixel(30 + i, 120, color);
	}
	
	while (1)
		;
}

